{% extends 'base.html' %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-6">
  <!-- Sidebar cat√©gories -->
  <aside class="card p-3 lg:sticky lg:top-20 h-fit">
    <div class="px-2 py-2 mb-2 border-b border-white/10">
      <div class="text-sm opacity-70">Serveur</div>
      <div class="font-semibold">{{ guild.name }}</div>
    </div>
    <nav class="flex flex-col gap-2">
      <a href="/g/{{ guild.id }}?tab=overview"
         class="px-3 py-2 rounded-lg border {{ 'bg-white/5 border-white/20' if tab=='overview' else 'border-white/10 hover:bg-white/5' }}">üìã Aper√ßu</a>
      <a href="/g/{{ guild.id }}?tab=config"
         class="px-3 py-2 rounded-lg border {{ 'bg-white/5 border-white/20' if tab=='config' else 'border-white/10 hover:bg-white/5' }}">‚öôÔ∏è Configuration</a>
      <a href="/g/{{ guild.id }}?tab=macros"
         class="px-3 py-2 rounded-lg border {{ 'bg-white/5 border-white/20' if tab=='macros' else 'border-white/10 hover:bg-white/5' }}">üìù Macros</a>
      <a href="/g/{{ guild.id }}?tab=coffre"
         class="px-3 py-2 rounded-lg border {{ 'bg-white/5 border-white/20' if tab=='coffre' else 'border-white/10 hover:bg-white/5' }}">üß∞ Coffre (galerie)</a>
      <a href="/g/{{ guild.id }}?tab=publish"
         class="px-3 py-2 rounded-lg border {{ 'bg-white/5 border-white/20' if tab=='publish' else 'border-white/10 hover:bg-white/5' }}">üì¢ Publier / Actions</a>
    </nav>
  </aside>

  <!-- Contenu principal -->
  <section class="space-y-6">

    {% if tab == 'overview' %}
      <div class="card p-5">
        <div class="mb-1 text-sm opacity-70">Aper√ßu</div>
        <h3 class="text-lg font-semibold mb-4">{{ guild.name }}</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="rounded-lg border border-white/10 p-3">
            <div class="text-sm opacity-70 mb-1">Panneaux rapides</div>
            <div class="flex flex-wrap gap-2">
              <a class="btn" href="/g/{{ guild.id }}?tab=config">Configurer</a>
              <a class="btn" href="/g/{{ guild.id }}?tab=coffre">Coffre</a>
              <a class="btn" href="/g/{{ guild.id }}?tab=macros">Macros</a>
              <a class="btn" href="/g/{{ guild.id }}?tab=publish">Publier</a>
            </div>
          </div>
          <div class="rounded-lg border border-white/10 p-3">
            <div class="text-sm opacity-70 mb-1">Raccourcis utiles</div>
            <ul class="text-sm space-y-1 opacity-80">
              <li>‚Ä¢ Synchroniser les commandes avec `/sync` ou `!syncguild`</li>
              <li>‚Ä¢ Utilise `/ticket-setup`, `/presence-panel`, `/bank-panel`, `/coffre panel`</li>
              <li>‚Ä¢ Les uploads Coffre se font **sur Discord** (panneau Coffre)</li>
            </ul>
          </div>
        </div>
      </div>
    {% endif %}

    {% if tab == 'config' %}
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-4">Configuration</h3>
        <form method="post" action="/g/{{ guild.id }}/config" class="grid md:grid-cols-2 gap-4">
          {% for f,l in fields %}
            <div>
              <label class="block text-sm opacity-70 mb-1">{{ l }}</label>
              <input name="{{ f }}" value="{{ (cfg.get(guild.id) or {}).get(f,'') }}"
                     class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2">
            </div>
          {% endfor %}
          <div class="md:col-span-2 flex gap-2 mt-2">
            <button class="btn btn-primary">Enregistrer</button>
            <a class="btn" href="/g/{{ guild.id }}/reset">R√©initialiser</a>
          </div>
        </form>
      </div>
    {% endif %}

    {% if tab == 'macros' %}
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-4">Macros (tickets)</h3>
        <form method="post" action="/g/{{ guild.id }}/macro/add" class="grid md:grid-cols-4 gap-3 items-end">
          <div>
            <label class="block text-sm opacity-70 mb-1">Type</label>
            <select name="ttype" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-2 py-2">
              <option value="rc">rc</option><option value="other">other</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm opacity-70 mb-1">Texte</label>
            <input name="text" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2"
                   placeholder="Placeholders: {user} {staff} {channel} {server} {subject}">
          </div>
          <button class="btn btn-primary">Ajouter</button>
        </form>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          {% for t in ['rc','other'] %}
            <div class="rounded-lg border border-white/10 p-3">
              <div class="font-medium mb-2">Type: {{ t }}</div>
              {% set arr = (macros.get(guild.id,{}).get(t,[])) %}
              {% if not arr %}<div class="opacity-60 text-sm">Aucune macro.</div>{% endif %}
              {% for i,m in enumerate(arr) %}
                <form method="post" action="/g/{{ guild.id }}/macro/remove" class="flex items-start gap-2 mb-2">
                  <input type="hidden" name="ttype" value="{{ t }}"><input type="hidden" name="index" value="{{ i }}">
                  <div class="flex-1 text-sm bg-zinc-900/60 border border-white/10 rounded px-2 py-2">{{ m }}</div>
                  <button class="btn">Suppr.</button>
                </form>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if tab == 'coffre' %}
      <div class="grid lg:grid-cols-[300px_1fr] gap-6">
        <!-- Roster -->
        <div class="card p-4">
          <div class="font-semibold mb-3">Roster Coffre</div>
          <input id="searchName" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2"
                 placeholder="Rechercher un nom‚Ä¶">
          <div id="nameList" class="mt-3 max-h-[60vh] overflow-auto space-y-1">
            {% for n in names %}
              <a href="/g/{{ guild.id }}?tab=coffre&name={{ n | urlencode }}"
                 data-name="{{ n | lower }}"
                 class="block px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 {{ 'bg-white/5 border-white/20' if n==selected_name else '' }}">
                {{ n }}
              </a>
            {% endfor %}
            {% if not names %}
              <div class="text-sm opacity-70">Aucun nom. Ajoute-les via `/coffre add-name` sur Discord (ou l‚ÄôAPI dashboard).</div>
            {% endif %}
          </div>
        </div>

        <!-- Galerie -->
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold">Galerie{% if selected_name %} ‚Äî {{ selected_name }}{% endif %}</div>
            {% if selected_name %}
              <a class="btn" href="/g/{{ guild.id }}?tab=coffre">Effacer la s√©lection</a>
            {% endif %}
          </div>

          {% if selected_name and photos %}
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {% for p in photos %}
                <a href="{{ p.url }}" target="_blank" class="group relative">
                  <img src="{{ p.url }}" class="w-full h-44 object-cover rounded-lg border border-white/10" alt="">
                  <div class="absolute bottom-1 right-1 text-[10px] px-1.5 py-0.5 rounded bg-black/60">par <span class="opacity-80">&lt;@{{ p.user_id }}&gt;</span></div>
                </a>
              {% endfor %}
            </div>
          {% elif selected_name and not photos %}
            <div class="opacity-70 text-sm">Aucune photo pour <b>{{ selected_name }}</b>.</div>
          {% else %}
            <div class="opacity-70 text-sm">S√©lectionne un nom dans la liste pour voir sa galerie.</div>
          {% endif %}
        </div>
      </div>

      <script>
        // filtre live sur le roster
        const q = document.getElementById('searchName');
        const list = document.getElementById('nameList');
        if(q && list){
          q.addEventListener('input', () => {
            const v = q.value.trim().toLowerCase();
            [...list.querySelectorAll('a[data-name]')].forEach(a => {
              a.style.display = a.dataset.name.includes(v) ? '' : 'none';
            });
          });
        }
      </script>
    {% endif %}

    {% if tab == 'publish' %}
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-4">Publier / Actions</h3>
        <form method="post" action="/g/{{ guild.id }}/queue" class="grid lg:grid-cols-6 gap-3 items-end">
          <div>
            <label class="block text-sm opacity-70 mb-1">Type</label>
            <select name="kind" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-2 py-2">
              <option value="PUBLISH_TICKETS">Panel Tickets</option>
              <option value="PUBLISH_PRESENCE">Panel Pr√©sence</option>
              <option value="PUBLISH_COFFRE">Panel Coffre</option>
              <option value="REFRESH_COFFRE_PANELS">Refresh Coffre Panels</option>
              <option value="SEND_EMBED">Envoyer un Embed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm opacity-70 mb-1">Channel ID</label>
            <input name="channel_id" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2">
          </div>
          <div class="lg:col-span-3">
            <label class="block text-sm opacity-70 mb-1">Options/Payload (JSON ou texte)</label>
            <input name="payload" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2"
                   placeholder='{"title":"Hello","description":"...","color":"#2f3136"}'>
          </div>
          <button class="btn btn-primary">Ajouter</button>
        </form>
        <p class="opacity-60 text-sm mt-2">Le bot lit <code>dashboard_queue.json</code> et ex√©cute les jobs.</p>
      </div>
    {% endif %}

  </section>
</div>

{% endblock %}
